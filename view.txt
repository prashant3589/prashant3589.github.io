- powershell: |
    $env:FLYWAY_LICENSE_KEY_FILE = "$(flywayPermit.secureFilePath)"
    flyway auth info
  displayName: 'Verify Flyway License'

- powershell: |
    flyway generate baseline `
      -url="$(DB_URL)" `
      -user="$(DB_USER)" `
      -password="$(DB_PASSWORD)" `
      -locations="filesystem:$(Build.SourcesDirectory)/migrations"
  displayName: 'Generate baseline'



- task: PowerShell@2
  displayName: "Commit Flyway migration scripts"
  inputs:
    targetType: inline
    script: |
      cd "$(Build.SourcesDirectory)"

      git status

      git add db/**/sql/*.sql

      # Check if there is anything to commit
      $changes = git status --porcelain
      if (-not $changes) {
        Write-Host "No migration changes to commit"
        exit 0
      }

      git config user.email "ado-pipeline@company.com"
      git config user.name "Azure DevOps Pipeline"

      git commit -m "Auto-generated Flyway migration from pipeline $(Build.BuildNumber)"
      git push origin HEAD:$(Build.SourceBranchName)
